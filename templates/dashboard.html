<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alarm System Performance Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .metric-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        .metric-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .metric-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-healthy { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .alarm-table {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-action {
            border-radius: 25px;
            padding: 8px 20px;
            margin: 5px;
        }
        .performance-tier {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .tier-excellent { background-color: #d4edda; color: #155724; }
        .tier-good { background-color: #d1ecf1; color: #0c5460; }
        .tier-fair { background-color: #fff3cd; color: #856404; }
        .tier-poor { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1><i class="fas fa-tachometer-alt"></i> Alarm System Performance Dashboard</h1>
                    <div class="d-flex align-items-center">
                        <span class="status-indicator status-healthy" id="statusIndicator"></span>
                        <span id="lastUpdate">Last update: --</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="metric-card info">
                    <div class="metric-value" id="alarmCount">0</div>
                    <div class="metric-label">Active Alarms</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card success">
                    <div class="metric-value" id="memoryUsage">0.0</div>
                    <div class="metric-label">Memory Usage (MB)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card warning">
                    <div class="metric-value" id="responseTime">0.0</div>
                    <div class="metric-label">Response Time (ms)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="performanceTier">Unknown</div>
                    <div class="metric-label">Performance Tier</div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="d-flex flex-wrap">
                    <button class="btn btn-primary btn-action" onclick="addTestAlarm()">
                        <i class="fas fa-plus"></i> Add Test Alarm
                    </button>
                    <button class="btn btn-info btn-action" onclick="addBulkAlarms()">
                        <i class="fas fa-layer-group"></i> Add Bulk Alarms
                    </button>
                    <button class="btn btn-warning btn-action" onclick="reloadAlarms()">
                        <i class="fas fa-sync"></i> Reload Alarms
                    </button>
                    <button class="btn btn-danger btn-action" onclick="clearAlarms()">
                        <i class="fas fa-trash"></i> Clear All Alarms
                    </button>
                    <a href="/add_alarm" class="btn btn-success btn-action">
                        <i class="fas fa-clock"></i> Add Custom Alarm
                    </a>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-line"></i> Alarm Count Over Time</h5>
                    <canvas id="alarmChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-area"></i> Memory Usage Over Time</h5>
                    <canvas id="memoryChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-bar"></i> Response Time Over Time</h5>
                    <canvas id="responseChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5><i class="fas fa-info-circle"></i> System Health</h5>
                    <div id="healthInfo">
                        <p>Loading health information...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Alarms Table -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="alarm-table">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-list"></i> Scheduled Alarms</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshAlarms()">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Code ID</th>
                                    <th>Email</th>
                                    <th>Time</th>
                                    <th>Recurring</th>
                                    <th>Days</th>
                                    <th>Timezone</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="alarmsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">Loading alarms...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast for notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage">
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Charts
        let alarmChart, memoryChart, responseChart;
        
        // Initialize charts
        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            };

            alarmChart = new Chart(document.getElementById('alarmChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Alarm Count',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            memoryChart = new Chart(document.getElementById('memoryChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Memory Usage (MB)',
                        data: [],
                        borderColor: '#11998e',
                        backgroundColor: 'rgba(17, 153, 142, 0.1)',
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });

            responseChart = new Chart(document.getElementById('responseChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Response Time (ms)',
                        data: [],
                        borderColor: '#f093fb',
                        backgroundColor: 'rgba(240, 147, 251, 0.1)',
                        tension: 0.4
                    }]
                },
                options: chartOptions
            });
        }

        // Update performance data
        function updatePerformanceData() {
            fetch('/api/performance')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('alarmCount').textContent = data.current_alarms.toLocaleString();
                    document.getElementById('memoryUsage').textContent = data.memory_usage.toFixed(2);
                    document.getElementById('responseTime').textContent = (data.response_time * 1000).toFixed(1);
                    document.getElementById('performanceTier').textContent = data.performance_tier;
                    document.getElementById('lastUpdate').textContent = `Last update: ${data.last_update || '--'}`;
                })
                .catch(error => console.error('Error updating performance data:', error));
        }

        // Update charts
        function updateCharts() {
            fetch('/api/history')
                .then(response => response.json())
                .then(data => {
                    if (data.timestamps && data.timestamps.length > 0) {
                        // Update alarm chart
                        alarmChart.data.labels = data.timestamps;
                        alarmChart.data.datasets[0].data = data.alarm_counts;
                        alarmChart.update();

                        // Update memory chart
                        memoryChart.data.labels = data.timestamps;
                        memoryChart.data.datasets[0].data = data.memory_usage;
                        memoryChart.update();

                        // Update response time chart
                        responseChart.data.labels = data.timestamps;
                        responseChart.data.datasets[0].data = data.response_times.map(t => t * 1000);
                        responseChart.update();
                    }
                })
                .catch(error => console.error('Error updating charts:', error));
        }

        // Update health information
        function updateHealthInfo() {
            fetch('/api/health')
                .then(response => response.json())
                .then(data => {
                    const healthDiv = document.getElementById('healthInfo');
                    const statusIndicator = document.getElementById('statusIndicator');
                    
                    if (data.status === 'healthy') {
                        statusIndicator.className = 'status-indicator status-healthy';
                        healthDiv.innerHTML = `
                            <div class="alert alert-success">
                                <h6><i class="fas fa-check-circle"></i> System Healthy</h6>
                                <p><strong>Service:</strong> ${data.service}</p>
                                <p><strong>Database:</strong> ${data.database}</p>
                                <p><strong>Redis:</strong> ${data.redis}</p>
                                <p><strong>Thread Running:</strong> ${data.thread_running ? 'Yes' : 'No'}</p>
                            </div>
                        `;
                    } else {
                        statusIndicator.className = 'status-indicator status-error';
                        healthDiv.innerHTML = `
                            <div class="alert alert-danger">
                                <h6><i class="fas fa-exclamation-triangle"></i> System Error</h6>
                                <p><strong>Error:</strong> ${data.message || 'Unknown error'}</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error updating health info:', error);
                    document.getElementById('statusIndicator').className = 'status-indicator status-error';
                });
        }

        // Update alarms table
        function updateAlarmsTable() {
            fetch('/api/alarms')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('alarmsTableBody');
                    
                    if (data.jobs && data.jobs.length > 0) {
                        tbody.innerHTML = data.jobs.map(alarm => `
                            <tr>
                                <td>${alarm.code_id}</td>
                                <td>${alarm.email}</td>
                                <td>${alarm.time}</td>
                                <td>
                                    <span class="badge ${alarm.is_recurring ? 'bg-success' : 'bg-secondary'}">
                                        ${alarm.is_recurring ? 'Yes' : 'No'}
                                    </span>
                                </td>
                                <td>${alarm.days_of_week || ''}</td>
                                <td>${alarm.timezone || ''}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAlarm('${alarm.code_id}', '${alarm.email}', '${alarm.time}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No alarms scheduled</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error updating alarms table:', error);
                    document.getElementById('alarmsTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading alarms</td></tr>';
                });
        }

        // Action functions
        function addTestAlarm() {
            fetch('/test_alarm', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showNotification(data.message, data.status === 'success' ? 'success' : 'danger');
                    if (data.status === 'success') {
                        setTimeout(updateAlarmsTable, 1000);
                    }
                })
                .catch(error => {
                    showNotification('Error creating test alarm', 'danger');
                });
        }

        function addBulkAlarms() {
            const count = prompt('How many alarms to create? (default: 10)', '10');
            if (!count) return;
            
            const numAlarms = parseInt(count);
            if (isNaN(numAlarms) || numAlarms <= 0) {
                showNotification('Please enter a valid number', 'warning');
                return;
            }
            
            if (numAlarms > 1000) {
                if (!confirm(`Are you sure you want to create ${numAlarms} alarms? This might take a while.`)) {
                    return;
                }
            }
            
            showNotification(`Creating ${numAlarms} alarms...`, 'info');
            
            fetch('/bulk_alarms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    count: numAlarms,
                    time_offset: 2
                })
            })
            .then(response => response.json())
            .then(data => {
                showNotification(data.message, data.status === 'success' ? 'success' : 'danger');
                if (data.status === 'success') {
                    setTimeout(updateAlarmsTable, 2000);
                }
            })
            .catch(error => {
                showNotification('Error creating bulk alarms', 'danger');
            });
        }

        function reloadAlarms() {
            fetch('/reload_alarms', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showNotification(data.message, data.status === 'success' ? 'success' : 'danger');
                    if (data.status === 'success') {
                        setTimeout(updateAlarmsTable, 1000);
                    }
                })
                .catch(error => {
                    showNotification('Error reloading alarms', 'danger');
                });
        }

        function clearAlarms() {
            if (confirm('Are you sure you want to clear all alarms?')) {
                fetch('/clear_alarms', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        showNotification(data.message, data.status === 'success' ? 'success' : 'danger');
                        if (data.status === 'success') {
                            setTimeout(updateAlarmsTable, 1000);
                        }
                    })
                    .catch(error => {
                        showNotification('Error clearing alarms', 'danger');
                    });
            }
        }

        function refreshAlarms() {
            updateAlarmsTable();
            showNotification('Alarms refreshed', 'info');
        }

        function deleteAlarm(codeId, email, time) {
            if (confirm(`Delete alarm ${codeId}?`)) {
                // This would need to be implemented in the backend
                showNotification('Delete functionality not implemented yet', 'warning');
            }
        }

        function showNotification(message, type) {
            const toast = document.getElementById('notificationToast');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = `toast ${type === 'success' ? 'bg-success text-white' : type === 'danger' ? 'bg-danger text-white' : type === 'warning' ? 'bg-warning' : 'bg-info text-white'}`;
            toastMessage.textContent = message;
            
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            
            // Initial load
            updatePerformanceData();
            updateCharts();
            updateHealthInfo();
            updateAlarmsTable();
            
            // Set up periodic updates
            setInterval(updatePerformanceData, 5000);
            setInterval(updateCharts, 10000);
            setInterval(updateHealthInfo, 15000);
            setInterval(updateAlarmsTable, 15000);
        });
    </script>
</body>
</html> 